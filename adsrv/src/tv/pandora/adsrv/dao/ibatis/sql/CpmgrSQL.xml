<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" 
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">
    <sqlMap namespace="CpmgrSQL">
    <typeAlias alias="cp" type="tv.pandora.adsrv.domain.Campaign" />
    <typeAlias alias="cr" type="tv.pandora.adsrv.domain.Creative" />
    <typeAlias alias="target" type="tv.pandora.adsrv.domain.Target" />
    <typeAlias alias="ads" type="tv.pandora.adsrv.domain.Ads" />
	
	
	 <sql id="ADS.STATE">
		select cpid, 
				sum(goal_total) goal_total,  sum(book_total) book_total,
				sum(if(goaltype=2, book_total, 0)) book_total_imp,
				sum(if(goaltype=3, book_total, 0)) book_total_click,
				sum(if(goaltype=4, book_total, 0)) book_total_hit,
				sum(if(goaltype=2, goal_total, 0)) goal_total_imp,
				sum(if(goaltype=3, goal_total, 0)) goal_total_click,
				sum(if(goaltype=4, goal_total, 0)) goal_total_hit,
				sum(if(ads_state=1 and substr(enddate, 1,8)>curdate()+0,1,0)) readycnt,
               sum(if(ads_state=2,1,0)) bookcnt,
               sum(if(ads_state=3,1,0)) runcnt,
               sum(if(ads_state=5,1,0)) completecnt,
               sum(if(ads_state=0,1,0)) pausecnt,
               sum(if(ads_state=-1,1,0)) stopcnt,
               <![CDATA[sum(if(ads_state=-2 or (ads_state=1 and substr(enddate, 1,8)<=curdate()+0),1,0) )]]> cancelcnt,
               sum(1) totcnt,
               max(a.adsid) max_adsid,
               count(t.targetid) target_cnt,
               sum(if(a.prtype=2,1,0)) prism_cnt
           from ads a	
                left join ads_targeting t on a.adsid = t.adsid and t.stat = 1       	           
          where a.stat = 1		 	  
			<isNotEmpty property="cpid" prepend="and"> cpid = #cpid#</isNotEmpty>
          group by cpid	
   	</sql>  
	<sql id="CP.STATE">
              case
              when ifnull(runcnt       ,0) > 0 then 3
              when ifnull(bookcnt      ,0) > 0 then 2
              when ifnull(readycnt     ,0) > 0 then 1
              when ifnull(completecnt  ,0) > 0 then 5
              when ifnull(pausecnt     ,0) > 0 then 0
              when ifnull(stopcnt      ,0) > 0 then -1
              when ifnull(cancelcnt    ,0) > 0 then -2
              when ifnull(totcnt       ,0) = 0 then -3
              else 0
              end cp_state,
              	sum(goal_total) goal_total,  sum(book_total) book_total,
				sum(book_total_imp  ) book_total_imp      ,
				sum(book_total_click) book_total_click    ,
				sum(book_total_hit  ) book_total_hit      ,
				sum(goal_total_imp  ) goal_total_imp      ,
				sum(goal_total_click) goal_total_click    ,
				sum(goal_total_hit  ) goal_total_hit      ,
				if(target_cnt>0,'Y','N') istarget, if(prism_cnt>0,'Y','N') isprism,
   </sql>	 
 	<select id="getCpList" resultClass="cp" parameterClass="java.util.Map">
select x.*, y.isname as cp_statename, y.text
 from (select a.cpid, a.cpname, a.startdate, a.enddate, 
              <include refid="CP.STATE" />
              a.clientid, c.corpname as clientname,
              a.agencyid, g.corpname as agencyname,
              a.medrepid, r.corpname as medrepname, a.tcid, t.username as tcname, a.budget,
              a.insertdate, a.updatedate, a.insertuser, a.updateuser, u.username as updateusername
             
    
         from campaign a
              left join 
              (
              	<include refid="ADS.STATE" />
			  )  b on a.cpid = b.cpid
              left join corporation c on a.clientid = c.corpid and c.corptype = 1
		      left join corporation g on a.agencyid = g.corpid and g.corptype = 2
		      left join corporation r on a.medrepid = r.corpid and r.corptype = 3
		      left join users t on a.tcid = t.userid
		      left join users u on a.updateuser = u.userid
        where a.stat = 1
	          <isNotEmpty property="clientid" prepend="and">  a.clientid = $clientid$</isNotEmpty>
	          <isNotEmpty property="agencyid" prepend="and">  a.agencyid = $agencyid$</isNotEmpty>
	          <isNotEmpty property="medrepid" prepend="and">  a.medrepid = $medrepid$</isNotEmpty>	  
	          <isNotEmpty property="sday" prepend="and"> 
	          <![CDATA[  substring(a.startdate,1,8) <= $eday$ and substring(a.enddate,1,8) >= $sday$]]>
	          </isNotEmpty>
        group by a.cpid
      ) x
      left join code_instance y on y.code = 'ads_state' and x.cp_state = y.isid
	<dynamic prepend="where">		 	  
		<isNotEmpty property="cp_state" prepend="and"> cp_state = $cp_state$</isNotEmpty>
		<isNotEmpty property="sch_text" prepend="and"> $sch_column$ like '%$sch_text$%' </isNotEmpty>
	</dynamic>	
	order by x.cpid desc
    <isNotEmpty property="max">
      limit $skip$,$max$
    </isNotEmpty>     
    </select>
	<select id="getCpCnt" resultClass="Integer" parameterClass="java.util.Map">		
	 select count(*)
		 from (select a.cpid, a.cpname, a.startdate, a.enddate, 
		              case
		              when ifnull(runcnt       ,0) > 0 then 3
		              when ifnull(bookcnt      ,0) > 0 then 2
		              when ifnull(readycnt     ,0) > 0 then 1
		              when ifnull(completecnt  ,0) > 0 then 5
		              when ifnull(pausecnt     ,0) > 0 then 0
		              when ifnull(stopcnt      ,0) > 0 then -1
		              when ifnull(cancelcnt    ,0) > 0 then -2
		              when ifnull(totcnt       ,0) = 0 then -3
		              else 0
		              end cp_state,
		              a.clientid, c.corpname as clientname,
		              a.agencyid, g.corpname as agencyname,
		              a.medrepid, r.corpname as medrepname, a.tcid, a.budget,
		              a.insertdate, a.updatedate, a.insertuser, a.updateuser, u.username as updateusername	       
		         from campaign a
		              left join 
		              (
		              <include refid="ADS.STATE" />
		              )  b on a.cpid = b.cpid
		              left join corporation c on a.clientid = c.corpid and c.corptype = 1
				      left join corporation g on a.agencyid = g.corpid and g.corptype = 2
				      left join corporation r on a.medrepid = r.corpid and r.corptype = 3
				      left join users t on a.tcid = t.userid
				      left join users u on a.updateuser = u.userid
		        where a.stat = 1
	          <isNotEmpty property="clientid" prepend="and">  a.clientid = $clientid$</isNotEmpty>
	          <isNotEmpty property="agencyid" prepend="and">  a.agencyid = $agencyid$</isNotEmpty>
	          <isNotEmpty property="medrepid" prepend="and">  a.medrepid = $medrepid$</isNotEmpty>
	          <isNotEmpty property="sday" prepend="and"> 
	          <![CDATA[  substring(a.startdate,1,8) <= $eday$ and substring(a.enddate,1,8) >= $sday$]]>
	          </isNotEmpty>
 		      ) x
		  <dynamic prepend="where">		 	  
				<isNotEmpty property="cp_state" prepend="and"> cp_state = $cp_state$</isNotEmpty>
				<isNotEmpty property="sch_text" prepend="and"> $sch_column$ like '%$sch_text$%' </isNotEmpty>
			</dynamic>	
	</select>
	<select id="getCampaign" resultClass="cp" parameterClass="java.util.Map">
	select x.*, y.isname as cp_statename, y.text
	 from (select a.cpid, a.cpname, a.startdate, a.enddate, 
             <include refid="CP.STATE" />
              ifnull(max_adsid,0) as max_adsid,
              a.clientid, c.corpname as clientname,
              a.agencyid, g.corpname as agencyname,
              a.medrepid, r.corpname as medrepname, a.tcid, t.username as tcname, a.budget, a.memo,
              a.insertdate, a.updatedate, a.insertuser, a.updateuser, u.username as updateusername	       
         from campaign a
              left join 
              (
				<include refid="ADS.STATE" />             

              )  b on a.cpid = b.cpid
              left join corporation c on a.clientid = c.corpid and c.corptype = 1
		      left join corporation g on a.agencyid = g.corpid and g.corptype = 2
		      left join corporation r on a.medrepid = r.corpid and r.corptype = 3
		      left join users t on a.tcid = t.userid
		      left join users u on a.updateuser = u.userid
        where a.cpid = #cpid#
      ) x
      left join code_instance y on y.code = 'ads_state' and x.cp_state = y.isid
   </select>
 	<select id="getAutoCorpList" resultClass="java.util.HashMap" parameterClass="java.util.Map">
		select a.corpname as label, a.corpid as value, a.corpname as id
		 from adsrv.corporation a  
		 where stat = 1
		 	and corptype = $corptype$
		 order by corpname
	</select>  
 
	<select id="getCodeList" resultClass="java.util.HashMap" parameterClass="java.util.Map">
		select a.code, a.isid, a.isname, text, isdefault
		 from code_instance a  
		      <isNotEmpty property="tbname"> inner join code_entity b on b.tbname = '$tbname$' and a.code = b.code</isNotEmpty>
		 where a.stat = 1
		 	<isNotEmpty property="code"  prepend="and"> a.code = '$code$' </isNotEmpty>
		 	<isNotEmpty property="code_str"  prepend="and"> a.code in ($code_str$) </isNotEmpty>
		 	<isNotEmpty property="not_code"  prepend="and"> a.code != '$not_code$' </isNotEmpty>
		 order by code, a.idx
	</select> 	
 	<select id="getCodeChangeList" resultClass="java.util.HashMap" parameterClass="java.util.Map">
   select distinct a.code, isid, isname, text, isdefault 
	from code_instance a
	     left join  allow_change b on b.nxtid = a.isid
	where a.code = 'ads_state' 
      and (a.isid = $curid$ or b.curid = $curid$)
	order by a.idx
	</select>



   
	<insert id="addCampaign" parameterClass="cp">	
	insert into adsrv.campaign
            (cpid,
             cpname,
             startdate,
             enddate,
             clientid,
             <isNotEmpty property="agencyid">agencyid, </isNotEmpty>
             <isNotEmpty property="medrepid">medrepid, </isNotEmpty>
             <isNotEmpty property="aeid">aeid, </isNotEmpty>
             budget,
             <isNotEmpty property="tcid">tcid, </isNotEmpty>
             <isNotEmpty property="memo">memo, </isNotEmpty>
              stat,
             insertdate,
             updatedate,
             insertuser,
             updateuser)
		values (0,
	        '$cpname$',
	        '$startdate$',
	        '$enddate$',
	        $clientid$,
	        <isNotEmpty property="agencyid">$agencyid$, </isNotEmpty>
	        <isNotEmpty property="medrepid">$medrepid$, </isNotEmpty>
	        <isNotEmpty property="aeid">$aeid$, </isNotEmpty>
	        '$budget$',
	        <isNotEmpty property="tcid">$tcid$, </isNotEmpty>
             <isNotEmpty property="memo">#memo#, </isNotEmpty>
	        1,
	        '$insertdate$',
	        '$insertdate$',
	        $insertuser$,
	        $insertuser$);
	        
	    	<selectKey resultClass="int">
	         SELECT LAST_INSERT_ID()
	        </selectKey>        
	        
	</insert>
 	<insert id="copyCampaign" parameterClass="java.util.Map">
	insert into adsrv.campaign
			(cpid,
             cpname,
             startdate,
             enddate,
             clientid,
             agencyid, 
             medrepid, 
             aeid, 
             budget,
             tcid,
             memo,
             stat,
             insertdate,
             updatedate,
             insertuser,
             updateuser)
	select 0 cpid,
		    concat(cpname, '_COPY') cpname,
            #startdate#,
            #enddate#,
            clientid,
            agencyid, 
            medrepid, 
            aeid, 
            budget,
            tcid,
            memo,
            1,
            #insertdate#,
            #insertdate#,
            #insertuser#,
            #insertuser#           
		from adsrv.campaign
		where cpid = #cpid#;
	      <selectKey resultClass="int">
	         SELECT LAST_INSERT_ID()
	      </selectKey> 
	</insert>	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	<update id="modCampaign" parameterClass="cp">
		update adsrv.campaign
		set
		  cpname      = #cpname#,     
		  startdate   = #startdate#,  
		  enddate     = #enddate#,     
		  clientid    = #clientid#,       
		  agencyid    = #agencyid#,    
		  medrepid    = #medrepid#,    
		  budget      = #budget#,      
		  tcid        = #tcid#,  
		  memo        = #memo#,
		  updatedate  = #updatedate#,         
		  updateuser  = #updateuser#		     
		where cpid = #cpid#;	
	</update>
	<select id="getCpAdsList" resultClass="ads" parameterClass="java.util.Map">
	select x.*, if(target_cnt>0,'Y','N') istarget, if(prtype=2,'Y','N') isprism
	from (
		select a.adsid, a.adsname, 
		       a.startdate, a.start_hour, a.start_min, a.enddate, a.end_hour, a.end_min, 
		       a.goaltype, g.isname as goaltypename, a.period, a.salestype, a.prtype, t.isname as prtypename,
			   a.budget, a.book_total, a.goal_total, a.goal_daily, 
			   a.ads_state, st.isname as ads_statename, st.text,  count(tg.targetid) target_cnt,
		       a.insertuser, a.insertdate, a.updateuser, u.username as updateusername, a.updatedate       
	      from adsrv.ads a
	           left join ads_targeting tg on a.adsid = tg.adsid and tg.stat = 1
			   left join users u on a.updateuser = u.userid
			   left join code_instance st on st.code = 'ads_state' and a.ads_state = st.isid
			   left join code_instance t on t.code = 'prtype' and a.prtype = t.isid
	  	       left join code_instance g on g.code = 'goaltype' and a.goaltype = g.isid
	     where a.cpid = $cpid$
	       and a.stat = 1
	       group by a.adsid
   ) x    
  	</select>
  	<select id="getAvailableAdsList" resultClass="ads" parameterClass="java.util.Map">	
		select a.adsid, a.adsname 
	      from adsrv.ads a
	     where a.cpid = $cpid$
	       and a.stat = 1
	       group by a.adsid   
  	</select>
	<select id="getAdsList" resultClass="ads" parameterClass="java.util.Map">
	select a.*, st.isname as ads_statename, st.text, u.username as updateusername,
	       if(target_cnt>0,'Y','N') istarget, if(prtype=2,'Y','N') isprism
	   from (select a.adsid, a.adsname, b.cpname, 				
		   			b.clientid, c.corpname as clientname,
			       <isNotEmpty property="sch_text">
					b.agencyid, g.corpname as agencyname,
					b.medrepid, r.corpname as medrepname,
					</isNotEmpty>
			       a.startdate, a.start_hour, a.start_min, a.enddate, a.end_hour, a.end_min, 
			       a.goaltype, g.isname as goaltypename, a.period, a.salestype, 
			       a.prtype, pt.isname as prtypename,
				   a.budget, a.cost, a.book_total, a.goal_total, a.goal_daily, 
				   a.ads_state, 
			       a.insertuser, a.insertdate, a.updateuser, a.updatedate,
			       count(t.targetid) target_cnt			             
		      from adsrv.ads a
		      	   left join ads_targeting t on a.adsid = t.adsid and t.stat = 1
		           left join adsrv.campaign b on a.cpid = b.cpid
				   left join corporation c on b.clientid = c.corpid and c.corptype = 1
		           left join code_instance pt on pt.code = 'prtype' and a.prtype = pt.isid
		           left join code_instance g on g.code = 'goaltype' and a.goaltype = g.isid
 			       <isNotEmpty property="sch_text">
			       left join corporation g on b.agencyid = g.corpid and g.corptype = 2
			       left join corporation r on b.medrepid = r.corpid and r.corptype = 3
			       </isNotEmpty>
		     where a.stat = 1
	              <isNotEmpty property="ads_state" prepend="and"> ads_state = $ads_state$</isNotEmpty>
	          <isNotEmpty property="sday" prepend="and"> 
	          <![CDATA[  substring(a.startdate,1,8) <= $eday$ and substring(a.enddate,1,8) >= $sday$]]>
	          </isNotEmpty>
		          group by a.adsid
			) a
			left join users u on a.updateuser = u.userid
			left join code_instance st on st.code = 'ads_state' and a.ads_state = st.isid
		<dynamic prepend="where">
		 		  <isNotEmpty property="sch_text" prepend="and"> $sch_column$ like '%$sch_text$%' </isNotEmpty>	
		</dynamic>
		order by a.insertdate desc
        <isNotEmpty property="max">
          limit $skip$,$max$
        </isNotEmpty>;  	
    </select>
	<select id="getAdsCnt" resultClass="Integer" parameterClass="java.util.Map">
	select count(*)
	   from (select adsid, a.adsname, b.cpname, 				
		   			b.clientid, c.corpname as clientname,
					b.agencyid, g.corpname as agencyname,
					b.medrepid, r.corpname as medrepname,
			       a.startdate, a.start_hour, a.start_min, a.enddate, a.end_hour, a.end_min, 
			       a.goaltype, a.period, a.salestype, a.prtype, 
				   a.budget, a.book_total, a.goal_total, a.goal_daily, a.ads_state, 
			       a.insertuser, a.insertdate, a.updateuser, a.updatedate       
		      from adsrv.ads a
		           left join adsrv.campaign b on a.cpid = b.cpid
				   left join corporation c on b.clientid = c.corpid and c.corptype = 1
			       left join corporation g on b.agencyid = g.corpid and g.corptype = 2
			       left join corporation r on b.medrepid = r.corpid and r.corptype = 3
		     where a.stat = 1
	              <isNotEmpty property="ads_state" prepend="and"> ads_state = $ads_state$</isNotEmpty>
	          <isNotEmpty property="sday" prepend="and"> 
	          <![CDATA[  substring(a.startdate,1,8) <= $eday$ and substring(a.enddate,1,8) >= $sday$]]>
	          </isNotEmpty>
			) a
			left join users u on a.updateuser = u.userid
			left join code_instance st on st.code = 'ads_state' and a.ads_state = st.isid
		<dynamic prepend="where">
		 		  <isNotEmpty property="sch_text" prepend="and"> $sch_column$ like '%$sch_text$%' </isNotEmpty>	
		</dynamic> 	
	</select>	
	<select id="getAds" resultClass="ads" parameterClass="java.util.Map">
		select a.cpid, b.clientid, adsid, a.adsname, 
		    a.startdate, a.start_hour, a.start_min, a.enddate, a.end_hour, a.end_min, a.realenddate,
		    a.period,
			a.goaltype, g.isname as goaltypename,
			a.salestype, s.isname as salestypename,
			a.prtype, p.isname as prtypename,
			a.ads_state, st.isname as ads_statename, st.text,
				   a.budget, a.cost, a.book_total, a.goal_total, a.goal_daily, 
			       a.insertuser, a.insertdate, a.updateuser, u.username as updateusername, a.updatedate       
		      from adsrv.ads a
		           left join campaign b on a.cpid = b.cpid
				   left join users u on a.updateuser = u.userid
				   left join code_instance p on p.code = 'prtype' and a.prtype = p.isid 
				   left join code_instance g on g.code = 'goaltype' and a.goaltype = g.isid
				   left join code_instance s on s.code = 'salestype' and a.salestype = s.isid
				   left join code_instance st on st.code = 'ads_state' and a.ads_state = st.isid
		     where a.adsid = $adsid$
		       and a.stat = 1
 	</select>
	<insert id="addAds" parameterClass="ads">
	insert into adsrv.ads
            (adsid,
             adsname,
             cpid,
             startdate,
             start_hour,
             start_min,
             enddate,
             end_hour,
             end_min,
             realenddate,
             stime,
             etime,
             goaltype,
             period,
             salestype,
             prtype,
             budget,
             <isNotEmpty property="cost">cost,</isNotEmpty>
             <isNotEmpty property="book_total">book_total,</isNotEmpty>
             <isNotEmpty property="goal_total">goal_total,</isNotEmpty>
             goal_daily,
             ads_state,
             stat,
             insertuser,
             insertdate,
             updateuser,
             updatedate             
		) values (0,
		        #adsname#,
		        #cpid#,
		        #startdate#,
		        #start_hour#,
		        #start_min#,
		        #enddate#,
		        #end_hour#,
		        #end_min#,
		        #realenddate#,
		        UNIX_TIMESTAMP(STR_TO_DATE(#startdate#, '%Y%m%d %H%i')),
		       	UNIX_TIMESTAMP(STR_TO_DATE(#realenddate#, '%Y%m%d %H%i')),
		       <!-- 	#stime#,
		       	#etime#, -->
		        #goaltype#,
		        #period#,
		        #salestype#,
		        #prtype#,
		        #budget#,
		        <isNotEmpty property="cost">#cost#,</isNotEmpty>
		        <isNotEmpty property="book_total">#book_total#,</isNotEmpty>
		        <isNotEmpty property="goal_total">#goal_total#,</isNotEmpty>
		        #goal_daily#,
		        1,
		        1,
		        #insertuser#,
		        #insertdate#,
		        #insertuser#,
		        #insertdate#
		);
	    	<selectKey resultClass="int">
	         SELECT LAST_INSERT_ID()
	        </selectKey>        
	
	</insert>
 	<insert id="copyAds" parameterClass="java.util.Map">
	insert into adsrv.ads(
		adsid, adsname, cpid, startdate, start_hour, start_min, enddate, end_hour, end_min, 
		realenddate, stime, etime, goaltype, period, salestype, prtype, budget, cost,
		book_total, goal_total, goal_daily, ads_state, stat, insertuser, insertdate, updateuser, updatedate
	)
	select 0 adsid,
		    concat(adsname, '_COPY') adsname,
            <isNotEmpty property="copyCpid"> $copyCpid$ </isNotEmpty> cpid,
            #startdate#,
            00,
            00,
            #enddate#,
            24,
            00,
            #realenddate#,
	      	UNIX_TIMESTAMP(STR_TO_DATE(#startdate#, '%Y%m%d %H%i')) stime,
	      	UNIX_TIMESTAMP(STR_TO_DATE(#realenddate#, '%Y%m%d %H%i')) etime,
            goaltype,
            period,
            salestype,
            prtype,
            budget,
            cost,
            book_total,
            goal_total,
            goal_daily,
            1 ads_state,
            1 stat,
            $insertuser$,
            $insertdate$,
            $insertuser$,
            $insertdate$ 
		from adsrv.ads
		where adsid = $adsid$;
	      <selectKey resultClass="int">
	         SELECT LAST_INSERT_ID()
	      </selectKey> 
	</insert>
 	<insert id="copyAdsTargeting" parameterClass="java.util.Map">	
	insert into adsrv.ads_targeting
   		(seq, adsid, targettype, targetid, updatedate, updateuser, stat)
	select 0,
		  $copyid$,
		  targettype,
		  targetid,
		  $insertdate$,
		  $insertuser$,
		  stat
	from adsrv.ads_targeting
	where adsid = $adsid$
	  and stat = 1
  </insert>
  <insert id="copyAdsCreative" parameterClass="java.util.Map">	
  insert into adsrv.ads_creative
            (adsid, crid, seq, stime, etime, startdate, start_hour, start_min, enddate,
             end_hour, end_min, weight, cr_state, insertuser, insertdate, updateuser, updatedate, stat, realenddate)
   select $copyid$,
          a.crid,
          0 seq,
          b.stime,
          b.etime,
          b.startdate,
          b.start_hour,
          b.start_min,
          b.enddate,
          b.end_hour,
          b.end_min,
          a.weight,
          a.cr_state,
          $insertuser$,
          $insertdate$,
          $insertuser$,
          $insertdate$,
          1,
          b.realenddate
     from adsrv.ads_creative a, ads b
    where a.adsid = $adsid$
      and a.stat = 1
      and a.adsid = b.adsid
  </insert>
  <insert id="copyAdsSlot" parameterClass="java.util.Map">
  insert into adsrv.ads_slot
            (adsid, slotid, seq, slot_state, insertuser, insertdate, updateuser, updatedate, stat)
   select $copyid$,
          slotid,
          seq,
          slot_state,
          $insertuser$,
          $insertdate$,
          $insertuser$,
          $insertdate$,
          stat
     from adsrv.ads_slot
    where adsid = $adsid$
      and stat = 1;
      </insert>
	<update id="modAds" parameterClass="ads">
	update adsrv.ads
	set   adsname      = #adsname#,   
	      startdate     = #startdate#,  
	      enddate       = #enddate#,    
	      start_hour     = #start_hour#, 
	      start_min     = #start_min#, 
	      end_hour       = #end_hour#,   
	      end_min       = #end_min#,  
	      realenddate       = #realenddate#,     
	      <!--  stime       = #stime#,   
	      etime       = #etime#,  -->
	      stime = UNIX_TIMESTAMP(STR_TO_DATE(#startdate#, '%Y%m%d %H%i')),
	      etime = UNIX_TIMESTAMP(STR_TO_DATE(#realenddate#, '%Y%m%d %H%i')),	      
	      goaltype      = #goaltype#,     
	      period        = #period#,       
	      salestype     = #salestype#,    
	      prtype        = #prtype#,       
	      budget        = #budget#,     
	      cost = #cost#, 
	      book_total = #book_total#, 
	      goal_total = #goal_total#, 
	      goal_daily   = #goal_daily#,
	      ads_state     = #ads_state#,            
	      updateuser    = #updateuser#,  
	      updatedate    = #updatedate#          
	where adsid = #adsid#
	;	
	</update>
	<update id="modDelAds" parameterClass="java.util.Map">
		update adsrv.ads
		   set stat = 0,
		       before_state = ads_state,
		       ads_state = -3,
		       updateuser    = $updateuser$,  
	           updatedate    = $updatedate$     
		where <isEqual property="allAdsDelete" compareValue="Y"> cpid = $cpid$ </isEqual>
		 	  <isNotEqual property="allAdsDelete" compareValue="Y">
		 	  	adsid = $del_adsid$
		 	  </isNotEqual>
	</update>
	<update id="modDelCampaign" parameterClass="java.util.Map">
	update adsrv.campaign
		set stat = 0,
            updateuser    = $updateuser$,  
	        updatedate    = $updatedate$  
	 where   <isEqual property="allAdsDelete" compareValue="Y">    
				 cpid = $cpid$ 
			</isEqual>
	</update>	
	
	<select id="getCreativeList" resultClass="cr" parameterClass="java.util.Map">
	 select x.*, y.`isname` as cr_statename, y.text
	   from (
			select a.`crid`, a.`crname`, a.`clientid`, b.`corpname` as clientname, 
			       a.`prtype`, t.isname as prtypename, a.`crtype`, a.width, a.`height`, a.`crurl`, max(ifnull(c.`cr_state`,0)) cr_state,
			       <isNotEmpty property="adsid"> ifnull(d.`adsid`,0) as</isNotEmpty><isEmpty property="adsid">0</isEmpty> selected, 
			       a.insertdate, a.insertuser, a.updatedate, a.updateuser, u.username as updateusername
			from creative a
			     left join ads_creative c on a.crid = c.crid and c.stat = 1 
			     left join ads f on f.stat = 1 and c.adsid = c.adsid 
			     <isNotEmpty property="adsid"> left join ads_creative d on a.crid = d.crid and d.adsid = $adsid$ and d.stat = 1</isNotEmpty>
			     left join corporation b on a.clientid = b.corpid
			     left join code_instance t on t.code = 'prtype' and a.prtype = t.isid
				 left join users u on a.updateuser = u.userid
		where a.stat = 1     
			  	<isNotEmpty property="clientid"> and a.clientid = $clientid$</isNotEmpty>
			  	<isNotEmpty property="cr_state"> and c.cr_state = $cr_state$</isNotEmpty>
			  	<isNotEmpty property="width"> and width = $width$</isNotEmpty>
			  	<isNotEmpty property="height"> and height = $height$</isNotEmpty>
			  	<isNotEmpty property="sday"> and substr(a.insertdate, 1, 8) between '$sday$' and '$eday$'</isNotEmpty>
			  	<isNotEmpty property="prtype"> and a.prtype = $prtype$ </isNotEmpty>
			  	<isNotEmpty property="crtype"> and a.crtype = $crtype$ </isNotEmpty>
			group by a.crid
	 		) x
	     	left join code_instance y on y.code = 'cr_state' and x.cr_state = y.isid 
	     	<dynamic prepend="where">
			<isNotEmpty property="sch_text" prepend="and"> $sch_column$ like '%$sch_text$%' </isNotEmpty>
	     	</dynamic>        
		 order by updatedate desc
         <isNotEmpty property="max">
          limit $skip$,$max$
          </isNotEmpty>;   	          
      </select> 
	<select id="getCreativeCnt" resultClass="Integer" parameterClass="java.util.Map">
	 select count(*)
	   from (
			select a.`crid`, a.`crname`, a.`clientid`, b.`corpname` as clientname, 
			       a.`prtype`, t.isname as prtypename, a.`crtype`, a.width, a.`height`, a.`crurl`, max(ifnull(c.`cr_state`,0)) cr_state,
			       a.insertdate, a.insertuser, a.updatedate, a.updateuser, u.username as insertusername
			from creative a
			     left join ads_creative c on a.crid = c.crid and c.stat = 1
			      left join ads f on f.stat = 1 and c.adsid = c.adsid 
			     left join corporation b on a.clientid = b.corpid
			     left join code_instance t on t.code = 'prtype' and a.prtype = t.isid
				 left join users u on a.updateuser = u.userid
		where a.stat = 1     
			  	<isNotEmpty property="crientid"> and a.crientid = $crientid$</isNotEmpty>
			  	<isNotEmpty property="crname"> and a.crname = '$crname$'</isNotEmpty>
			  	<isNotEmpty property="cr_state"> and c.cr_state = $cr_state$</isNotEmpty>
			  	<isNotEmpty property="width"> and width = $width$</isNotEmpty>
			  	<isNotEmpty property="height"> and height = $height$</isNotEmpty>
			  	<isNotEmpty property="sday"> and substr(a.insertdate, 1, 8) between '$sday$' and '$eday$'</isNotEmpty>
			  	<isNotEmpty property="prtype"> and a.prtype = $prtype$ </isNotEmpty>
			  	<isNotEmpty property="crtype"> and a.crtype = $crtype$ </isNotEmpty>
			group by a.crid
	 		) x
	     	left join code_instance y on y.code = 'cr_state' and x.cr_state = y.isid 
	     	<dynamic prepend="where">
			<isNotEmpty property="sch_text" prepend="and"> $sch_column$ like '%$sch_text$%' </isNotEmpty>
	     	</dynamic>        
	  </select> 
	<select id="getCrnameCnt" resultClass="Integer" parameterClass="java.util.Map">
	select count(*)
	   from creative a
		where a.stat = 1     
		and a.crname = '$crname$'
		<isNotEmpty property="not_crid"> and crid != $not_crid$</isNotEmpty>
	  </select> 
	<select id="getCpCreativeList" resultClass="cr" parameterClass="java.util.Map">
     select a.`adsid`, c.adsname, a.`crid`, b.crname, b.width, b.height, 
		       b.prtype, t.isname as prtypename, a.startdate, a.start_hour, a.start_min,
		       a.enddate, a.end_hour, a.end_min, a.weight, a.updatedate, a.updateuser, u.username as updateusername,
		       a.cr_state, st.isname as cr_statename, b.crurl, st.text
	      from ads_creative a
	  		   left join creative b on a.crid = b.crid 
			   left join ads c on a.adsid = c.adsid 
			   left join code_instance t on t.code = 'prtype' and b.prtype = t.isid
		       left join code_instance st on st.code = 'cr_state' and a.cr_state = st.isid
		       left join users u on a.updateuser = u.userid
 		 where a.stat = 1
 		 and b.stat = 1
 		 and c.stat = 1
 		   and c.cpid = $cpid$
		   <isNotEmpty property="adsid"> and a.adsid = $adsid$ </isNotEmpty>
			;
    </select>
	<select id="getCreative" resultClass="cr" parameterClass="java.util.Map">
			select a.`crid`, a.`crname`, a.`clientid`, b.`corpname` as clientname, richmedia,
			       a.`prtype`, t.isname as prtypename, a.`crtype`, a.width, a.`height`, a.`crurl`, a.tmpid,
			       a.insertdate, a.insertuser, a.updatedate, a.updateuser, u.username as updateusername
			from creative a
			     left join corporation b on a.clientid = b.corpid
			     left join code_instance t on t.code = 'prtype' and a.prtype = t.isid
				 left join users u on a.updateuser = u.userid
		where a.stat = 1     
	      and a.crid = $crid$
     </select>     
    <select id="getCrClickList" resultClass="java.util.HashMap" parameterClass="java.util.Map">
    select ckid, clickname, clickurl, 
           a.updatedate, a.updateuser, u.username as updateusername
      from creative_click a
            left join users u on a.updateuser = u.userid
      where crid = $crid$
        and a.stat = 1
    </select>
    <select id="getCrFileList" resultClass="java.util.HashMap" parameterClass="java.util.Map">
    select fileidx, filename, imgurl, filesize, contenttype, 
           a.updatedate, a.updateuser, u.username as updateusername
      from creative_file a
            left join users u on a.updateuser = u.userid
      where crid = $crid$
        and a.stat = 1
     </select>
	<insert id="addCreative" parameterClass="cr">	
		insert into adsrv.creative
            (crid,
             crname,
             clientid,
             <isNotEmpty property="crtype">crtype,</isNotEmpty>
             <isNotEmpty property="crurl">crurl,</isNotEmpty>
             width,
             height,
             tmpid,
             richmedia,
             realcode,
             prtype,
             stat,
             insertdate,
             insertuser,
             updatedate,	
             updateuser
        )values (
        	0,
	        '$crname$',
	        $clientid$,
	        <isNotEmpty property="crtype">$crtype$,</isNotEmpty>
	        <isNotEmpty property="crurl">'$crurl$',</isNotEmpty>
	        $width$,
	        $height$,
	        $tmpid$,
	        #richmedia#,
	        #realcode#,
	        $prtype$,
	        1,
	        '$insertdate$',
	        $insertuser$,
	        $insertdate$,
	        $insertuser$
	      );
	      <selectKey resultClass="int">
	         SELECT LAST_INSERT_ID()
	      </selectKey> 
 	</insert>
 	<insert id="copyCreative" parameterClass="java.util.Map">
		insert into adsrv.creative
		select 0 crid,
			  concat(crname, '_COPY') crname,
			  clientid,
			  crtype,
			  crurl,
			  width,
			  height,
			  tmpid,
			  richmedia,
			  realcode,
			  prtype,
			  stat,
			  $insertdate$,
			  $insertuser$,
			  $insertdate$,
			  $insertuser$
		from adsrv.creative
		where crid = $crid$;
	      <selectKey resultClass="int">
	         SELECT LAST_INSERT_ID()
	      </selectKey> 
	</insert>
 	<insert id="copyCreativeClick" parameterClass="java.util.Map">
		insert into adsrv.creative_click(
			crid
			, ckid
			, clickname
			, clickurl
			, updatedate
			, updateuser
			, stat
		)
		select $copyid$,
			  0,
			  clickname,
			  clickurl,
			  $insertdate$,
			  $insertuser$,
			  1
		from adsrv.creative_click
		where crid = $crid$
		  and stat = 1;	       
	</insert>
 	
	<insert id="addCreativeClick" parameterClass="java.util.Map">
         INSERT INTO creative_click (
			crid
			, ckid
			, clickname
			, clickurl
			, updatedate
			, updateuser
			, stat
		) 
		<dynamic>
			<iterate prepend="VALUES" conjunction=", " property="List">
				( 
					#List[].crid# 
					, 0
					, #List[].clickname#
					, #List[].clickurl#
					, #List[].updatedate# 	
					, #List[].updateuser# 	
					, 1		
				)
			</iterate>
		</dynamic>
     </insert>
 	<insert id="addCreativeFile" parameterClass="java.util.Map">
         INSERT INTO creative_file (
			 crid,
             fileidx,
             filename,
             imgurl,
             filesize,
             contenttype,
             updatedate,
             updateuser,
             stat
		) 
		<dynamic>
			<iterate prepend="VALUES" conjunction=", " property="List">
				( 
					#List[].crid# 
					, 0
					, #List[].filename#
					, #List[].imgurl#	
					, #List[].filesize#	
					, #List[].contenttype#	
					, #List[].updatedate#	
					, #List[].updateuser#	
					, 1		
				)
			</iterate>
		</dynamic>
      </insert>	
      <update id="delFile" parameterClass="java.util.Map">
      	update creative_file
      	  set stat = 0
      	where crid = $crid$
      	  and fileidx = $fileidx$
      </update>
      <update id="delClick" parameterClass="java.util.Map">
      	update creative_click
      	  set stat = 0
      	where crid = $crid$
      	  and ckid = $ckid$
      </update>
      <update id="modCreative" parameterClass="cr">	
		update adsrv.creative
		set   <isNotEmpty property="crname">crname        = '$crname$', </isNotEmpty>     
		      <isNotEmpty property="clientid">clientid       = $clientid$, </isNotEmpty>      
		      <isNotEmpty property="prtype">prtype        = $prtype$, </isNotEmpty>       
		      <isNotEmpty property="crurl">crurl         = '$crurl$', </isNotEmpty>      
		      <isNotEmpty property="width">width         = $width$, </isNotEmpty>        
		      <isNotEmpty property="height">height        = $height$, </isNotEmpty>       
		      <isNotEmpty property="tmpid">tmpid         = $tmpid$, </isNotEmpty>  
		      <isNotEmpty property="realcode">realcode     = #realcode#, </isNotEmpty>  
		      <isNotEmpty property="richmedia">richmedia     = #richmedia#, </isNotEmpty>  
		       <isNotEmpty property="stat">stat          = $stat$, </isNotEmpty>
		      updateuser    = $updateuser$,  
		      updatedate    = $updatedate$          
		where crid = $crid$;
	</update>

		
	<select id="getTargetCodeList" resultClass="java.util.HashMap" parameterClass="java.util.Map">
	   select a.entno, a.entname, tname, tseq, tvalue, x.text
		 from
		 (select a.code, a.isid, a.isname, text, isdefault
		 from code_instance a  
		      inner join code_entity b on b.tbname = 'target' and a.code = b.code
		 where a.stat = 1
		   and a.code = 'targettype' 
		   and isid = $targettype$
		 ) x
		 left join target_entity a on x.isid = a.targettype		
		 left join target_evalue b on a.entno = b.entno
	</select>
	<select id="getTargetList" resultClass="java.util.HashMap" parameterClass="java.util.Map">
		select a.targettype, i.isname as targettypename, a.tid, a.targetname, 
		       a.updateuser, u.username as updateusername, a.updatedate 
		 from target a		     
		      left join users u on a.updateuser = u.userid
		      left join code_instance i on i.code = 'targettype' and i.isid = a.targettype
		 where a.stat = 1     
		  	<isNotEmpty property="targettype"> and a.targettype = $targettype$ </isNotEmpty>
		  	<isNotEmpty property="sch_text" prepend="and"> targetname like '%$sch_text$%' </isNotEmpty>
		 order by <isNotEmpty property="order_str"> $order_str$ ,</isNotEmpty>
		 a.updatedate desc
         <isNotEmpty property="max">
          limit $skip$,$max$
          </isNotEmpty>;
	</select>
	<select id="getAdsTargetList" resultClass="java.util.HashMap" parameterClass="java.util.Map">	
		<!-- select a.`adsid`, c.adsname, b.targettype, i.isname as targettypename, b.tid, b.targetname, a.updatedate, a.updateuser, u.username as updateusername
		 from ads_targeting a 
		      left join target b on a.targetid = b.tid
		      left join ads c on a.adsid = c.adsid
		      left join code_instance i on i.code = 'targettype' and i.isid =b.targettype
		      left join users u on a.updateuser = u.userid
		where b.stat = 1
			 <isNotEmpty property="cpid"> and c.cpid = $cpid$</isNotEmpty>
			 <isNotEmpty property="adsid"> and a.adsid = $adsid$</isNotEmpty>
		 --> 
		select x.*, y.adsid, y.adsname, y.tid, y.targetname, y.updatedate, u.username as updateusername 
		  from (select i.isid as targettype, i.isname as targettypename, i.idx
		          from code_instance i	
		         where i.code = 'targettype'
		 		) x
		 		left join 
				(select c.adsid, c.adsname, b.`targettype`, b.`tid`, b.`targetname`, a.updatedate, a.updateuser
				    from ads_targeting a 
				         left join ads c on a.`adsid` = c.`adsid`
				         inner join target b on a.targetid = b.tid
				  where a.stat = 1
				    and c.stat = 1
				   		<isNotEmpty property="cpid"  prepend="and">  c.cpid = $cpid$</isNotEmpty>
			 			<isNotEmpty property="adsid"  prepend="and">  a.adsid = $adsid$</isNotEmpty>
				  
				 ) y on x.targettype = y.targettype		 
		         left join users u on y.updateuser = u.userid
		         <isEmpty property="adsid"> where y.adsid is not null </isEmpty>
		   order by x.idx	 
	</select>
	<select id="getNewAdsTargetList" resultClass="java.util.HashMap" parameterClass="java.util.Map">	
		select b.targettype, i.isname as targettypename, b.tid, b.targetname
		 from target b 
		      left join code_instance i on i.code = 'targettype' and i.isid =b.targettype
		      left join users u on b.updateuser = u.userid
		where b.stat = 1
		order by i.idx, tid
	</select>
	<select id="getAdsTargetSelectList" resultClass="java.util.HashMap" parameterClass="java.util.Map">	
	select a.targettype, i.isname as targettypename, a.tid, a.targetname, b.targetid
		 from target a
		      left join ads_targeting b on b.adsid = $adsid$ and a.tid = b.targetid and b.stat = 1
		      left join code_instance i on i.code = 'targettype' and a.targettype = i.isid
		 where a.stat = 1
		 order by i.idx, a.updatedate desc 
	</select>
	<select id="getTargetCnt" resultClass="Integer" parameterClass="java.util.Map">
		select count(*)
		 from target a		     
		      left join users u on a.updateuser = u.userid
		      left join code_instance i on i.code = 'targettype' and i.isid = a.targettype
		 where a.stat = 1     
		  	<isNotEmpty property="targettype"> and a.targettype = $targettype$ </isNotEmpty>
		  	<isNotEmpty property="sch_text" prepend="and"> targetname like '%$sch_text$%' </isNotEmpty>
	</select>
	
	
	<insert id="addAdsTargeting" parameterClass="java.util.Map">
         INSERT INTO ads_targeting (
			adsid, targettype, targetid, updatedate, updateuser, stat
		) 
		<dynamic>
			<iterate prepend="VALUES" conjunction=", " property="List">
				( 
					#List[].adsid#,
					#List[].targettype#,
					#List[].tid#,
					#List[].updatedate#,
					#List[].updateuser#,
					1
				) 
			</iterate>
		</dynamic>
		ON DUPLICATE KEY UPDATE
    		targetid = VALUES(targetid),
    		updatedate = VALUES(updatedate),
    		updateuser = VALUES(updateuser),
    		stat = 1
      </insert>
	  <update id="modDelAdsTargeting" parameterClass="java.util.Map">
	  	update ads_targeting
	  	   set stat = 0,
	  	       updatedate = $updatedate$,
	  	       updateuser = $updateuser$
		 <isEqual property="allAdsDelete" compareValue="Y">
		 where cpid = $cpid$ 
		 </isEqual>
	 	 <isNotEqual property="allAdsDelete" compareValue="Y">
		 	where	adsid = $del_adsid$		 	
	  	  	<isNotEmpty property="tgstr"> and targettype not in ($tgstr$)</isNotEmpty>
	  	  </isNotEqual>
	  </update>
	<insert id="addAdsSlot" parameterClass="java.util.HashMap">
	insert into ads_slot (
			adsid,
		    slotid,
		    seq, 
		    slot_state, 
		    insertdate, 
		    insertuser, 
		    updatedate, 
		    updateuser, 
		    stat
			) 
		<dynamic>
			<iterate prepend="VALUES" conjunction=", " property="List">
				( 
					#List[].adsid#,
					#List[].slotid#,
			        0,
			        1,
					#List[].insertdate#,
					#List[].insertuser#,
					#List[].updatedate#,
					#List[].updateuser#,
	      			1
	      		) 
			</iterate>
		</dynamic>
		ON DUPLICATE KEY UPDATE   		
	        updatedate = VALUES(updatedate),
	        updateuser = VALUES(updateuser),
     		stat = 1
	</insert>
	
	
    <insert id="addAdsNewCreative" parameterClass="java.util.Map">
         INSERT INTO ads_creative (
			adsid,  
	        crid,
	        seq,
	        stime,
	        etime,
	        startdate,         
	        enddate,
	        realenddate,
	        weight,
	        cr_state,
	        insertuser,
	        insertdate,
	        updatedate,
	        updateuser,
	        stat
		) select 
		adsid,  
	        crid,
	        0 seq,
	        stime,
	        etime,
	        startdate,         
	        enddate,
	        realenddate,
	        100 weight,
	        1 cr_state,
	        $insertuser$,
	        $insertdate$,
	        $insertuser$,
	        $insertdate$,
	        1
	        from creative b 
	             left join ads a on a.adsid = $adsid$
	        where b.crid in ($new_crstr$)
      </insert>	
	
	
	
	
	
	
	
	<insert id="addAdsCrNew" parameterClass="java.util.Map">
	INSERT INTO ads_creative (
			adsid,  
	        crid,
	        seq,
	        stime,
	        etime,
	        startdate,         
	        enddate,
	        realenddate,
	        weight,
	        cr_state,
	        insertuser,
	        insertdate,
	        updatedate,
	        updateuser,
	        stat
		) 
		select adsid,
		       #crid#,
		       0,
		       stime, 
		       etime,
		       startdate,
		       enddate,
		       realenddate,
		       100 weight,
		       1 cr_state,
		       #insertuser#,
		       #insertdate#,
		       #insertdate#,
		       #insertuser#,
		       1
		  from ads
		  where adsid = #adsid#
		       
	</insert>
	
	
	
	
	<insert id="addAdsCreative" parameterClass="java.util.Map">
         INSERT INTO ads_creative (
			adsid,  
	        crid,
	        seq,
	        stime,
	        etime,
	        startdate,         
	        enddate,
	        realenddate,
	        weight,
	        cr_state,
	        insertuser,
	        insertdate,
	        updatedate,
	        updateuser,
	        stat
		) 
		<dynamic>
			<iterate prepend="VALUES" conjunction=", " property="List">
				( 
					#List[].adsid#,
					#List[].crid#,
					0,
					UNIX_TIMESTAMP(STR_TO_DATE(#List[].startdate#, '%Y%m%d %H%i')),
			       	UNIX_TIMESTAMP(STR_TO_DATE(#List[].realenddate#, '%Y%m%d %H%i')),
					#List[].startdate#,
					#List[].enddate#,
					#List[].realenddate#,
					#List[].weight#,
					#List[].cr_state#,
					#List[].insertuser#,
					#List[].insertdate#,
					#List[].updatedate#,
					#List[].updateuser#,
					1
				) 
			</iterate>
		</dynamic>
		ON DUPLICATE KEY UPDATE   		
    		stime = UNIX_TIMESTAMP(STR_TO_DATE(VALUES(startdate), '%Y%m%d %H%i')),
	        etime = UNIX_TIMESTAMP(STR_TO_DATE(VALUES(realenddate), '%Y%m%d %H%i')),
	        startdate = VALUES(startdate),         
	        enddate = VALUES(enddate),
	        realenddate = VALUES(realenddate),
	        weight = VALUES(weight),
	        cr_state = VALUES(cr_state),
	        updatedate = VALUES(updatedate),
	        updateuser = VALUES(updateuser),
     		stat = 1
      </insert>
	<update id="modDelAdsCreative" parameterClass="java.util.HashMap">			  
	  	update ads_creative
	  	   set stat = 0,
	  	       before_state = cr_state,
	  	       cr_state = -1,
	  	       updatedate = $updatedate$,
	  	       updateuser = $updateuser$
	  	where 
		      <isEqual property="allAdsDelete" compareValue="Y"> cpid = $cpid$ </isEqual>
		 	  <isNotEqual property="allAdsDelete" compareValue="Y">
		 	  
		 	  		  <isNotEmpty property="del_adsid"> 
				  	  adsid = $del_adsid$
				  	  </isNotEmpty>	
		 	  		  <isEmpty property="del_adsid">
						  	  <isNotEmpty property="crstr"> 
						  	  adsid = $adsid$ and crid in ($crstr$)
						  	  </isNotEmpty>
						  	  <isNotEmpty property="del_crid"> 
						  	  crid = $del_crid$
						  	  </isNotEmpty>
				  	  </isEmpty>
	 	  	
		 	  </isNotEqual>
	</update>
	<update id="modDelCreative" parameterClass="java.util.HashMap">			  
	  	update creative
	  	   set stat = 0,
	  	       updatedate = $updatedate$,
	  	       updateuser = $updateuser$
	  	where crid = $crid$	  	  
	</update>
	<update id="modAdsSlot" parameterClass="java.util.HashMap">
		update adsrv.ads_slot
		  set <isNotEmpty property="slot_state"> slot_state = $slot_state$, </isNotEmpty>
		      <isNotEmpty property="stat"> stat = $stat$, </isNotEmpty>
		      updatedate = $updatedate$,
		      updateuser = $updateuser$
		where adsid = $adsid$
		  <isNotEmpty property="slotstr">and slotid in ($slotstr$) </isNotEmpty>
		  <isNotEmpty property="slotid">and slotid = $slotid$ </isNotEmpty>
	</update>
	
	
	
	<update id="modDelAdsSlot" parameterClass="java.util.HashMap">
		update adsrv.ads_slot
		  set slot_state = -1, 
		      stat = 0, 
		      updatedate = $updatedate$,
		      updateuser = $updateuser$
		where 
		      <isEqual property="allAdsDelete" compareValue="Y"> cpid = $cpid$ </isEqual>
		 	  <isNotEqual property="allAdsDelete" compareValue="Y">
					adsid = $del_adsid$
		 	  </isNotEqual>
	</update>	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	<insert id="addAdsSlotByGroup" parameterClass="java.util.HashMap">
	insert into adsrv.ads_slot
    (	adsid,
	    slotid,seq, 
	    slot_state, 
	    insertdate, 
	    insertuser, 
	    updatedate, 
	    updateuser, 
	    stat
    ) 
    select $adsid$,
		  slotid,
		  0,
		  1,
	      $insertdate$,
	      $insertuser$,
	      $insertdate$,
	      $insertuser$,
		  1
     from slotgroup_slot
     where groupid = $groupid$
       and stat = 1
       and slotid not in (select slotid from ads_slot a where a.adsid = $adsid$ and a.stat = 1)
	on duplicate key update stat = 1;
	</insert>	
	<insert id="addTarget" parameterClass="java.util.Map">
		insert into adsrv.target
            (tid,
             targetname,
             targettype,
             updatedate,
             updateuser,
             stat
          	) values (0,
	        '$targetname$',
	        $targettype$,
	        $updatedate$,
	        $updateuser$,
	        1);
	    	<selectKey resultClass="int">
	         SELECT LAST_INSERT_ID()
	        </selectKey>  	
	</insert>
	<update id="modTarget" parameterClass="java.util.Map">
		update adsrv.target
		   set <isNotEmpty property="targetname">targetname = '$targetname$', </isNotEmpty>
		       <isNotEmpty property="stat">stat = $stat$, </isNotEmpty>
		       updatedate = $updatedate$,
               updateuser = $updateuser$
           where tid = $tid$;
	</update>
	<select id="getTarget" resultClass="target" parameterClass="java.util.Map">
		select a.targettype, i.isname as targettypename, a.tid, a.targetname, i.text as targetmenu,
		       a.updateuser, u.username as updateusername, a.updatedate 
		 from target a		     
		      left join users u on a.updateuser = u.userid
		      left join code_instance i on i.code = 'targettype' and i.isid = a.targettype
		 where a.stat = 1   
		   and a.tid = $tid$  
		  	       
	</select>	
	<select id="getSystemTargetValue" resultClass="target" parameterClass="java.util.Map">
	 select a.tid, a.targetname, a.targettype, freqday, freqcap, day, browser, time
	   from target a
			left join target_system b on a.tid = b.tid 
	  where a.tid = $tid$
	</select>
	
	
	
	
	<select id="getIpTargetValList" resultClass="target" parameterClass="java.util.Map">	
	select a.tid, a.targetname, a.targettype, idx, ip_from, ip_to, ip_alias
      from target a
		   inner join target_ip b on a.tid = b.tid 
	  where a.tid = $tid$
		and b.stat = 1
	 order by idx
	</select>
	<select id="getCategoryTargetValue" resultClass="target" parameterClass="java.util.Map">
	select a.tid, a.targetname, a.targettype, category
  	  from target a
		   inner join target_category b on a.tid = b.tid 
	  where a.tid = $tid$
	</select>
	<select id="getChannelTargetValue" resultClass="target" parameterClass="java.util.Map">
	  select a.tid, a.targetname, a.targettype, b.`excflag`, b.`slotid`, s.secid, s.siteid
	   from target a
			inner join target_channel b on a.tid = b.tid 
			left join slot s on b.slotid = s.slotid 
	  where a.tid = $tid$
	
	</select>
	<select id="getChannelTargetValList" resultClass="target" parameterClass="java.util.Map">
		select tid, idx, channelid, channelname
		   from target_channel_id a 			
		  where tid = $tid$
		    and stat = 1
		  order by idx	
	</select>	
	<select id="getCountryTargetValue" resultClass="target" parameterClass="java.util.Map">	
		select a.tid, a.targetname, a.targettype, 
	           b.excflag, country1, country2, country3, country4, country5, country6, country7, country8
		  from target a
			   inner join target_country b on a.tid = b.tid 
	     where a.tid = $tid$
	</select>

	<insert id="addTargetSystem" parameterClass="java.util.Map">	
		insert into adsrv.target_system
	            (tid,
	             freqday,
	             freqcap,
	             day,
	             browser,
	             time)
		values ($tid$,
		        $freqday$,
		        $freqcap$,
		        $day$,
		        $browser$,
		        $time$);
	</insert>
	<update id="modTargetSystem" parameterClass="java.util.Map">
		update adsrv.target_system
		   set freqday = $freqday$, 
		       freqcap = $freqcap$, 
		       day = $day$, 
		       browser = $browser$, 
		       time = $time$
           where tid = $tid$;
	</update>

	<insert id="addTargetIP" parameterClass="java.util.HashMap">
		INSERT INTO target_ip (
			tid
			, idx
			, ip_from
			, ip_to
			, ip_alias
			, stat
		) 
		<dynamic>
			<iterate prepend="VALUES" conjunction=", " property="List">
				( 
					#List[].tid# 
					, 0
					, #List[].ip_from#
					, #List[].ip_to#
					, #List[].ip_alias#	
					, 1			
				)
			</iterate>
		</dynamic>
	</insert>
   <update id="modTargetIP" parameterClass="java.util.Map">
		update adsrv.target_ip
		   set stat = 0
           where tid = $tid$
             ;
	</update> 
 	<delete id="delTargetIP" parameterClass="java.util.HashMap">
		delete 
		  from target_ip
		 where tid = $tid$
		   and stat = 0
	</delete>
	
	<insert id="addTargetCategory" parameterClass="java.util.Map">
		insert into adsrv.target_category
		            (tid,
		             category)
		values ($tid$,
		        $category$);
	</insert>
	<update id="modTargetCategory" parameterClass="java.util.Map">
		update adsrv.target_category
		   set category = $category$
           where tid = $tid$;
	</update>
	
	
	<insert id="addTargetCountry" parameterClass="java.util.Map">
		insert into adsrv.target_country
		            (tid,
		             excflag,
		             country1,
		             country2,
		             country3,
		             country4,
		             country5,
		             country6,
		             country7,
		             country8)
		values ($tid$,
		        $excflag$,
		        $country1$,
		        $country2$,
		        $country3$,
		        $country4$,
		        $country5$,
		        $country6$,
		        $country7$,
		        $country8$);
    </insert>
    <update id="modTargetCountry" parameterClass="java.util.Map">
		update adsrv.target_country
		   set excflag = $excflag$,
		   	   country1 = $country1$,
		   	   country2 = $country2$,
		   	   country3 = $country3$,
		   	   country4 = $country4$,
		   	   country5 = $country5$,
		   	   country6 = $country6$,
		   	   country7 = $country7$,
		   	   country8 = $country8$
           where tid = $tid$;
	</update>
    
    
	<insert id="addTargetChannel" parameterClass="java.util.Map">
	    insert into adsrv.target_channel
                (tid,
                 excflag,
                 slotid)
	    values ($tid$,
	            $excflag$,
	            $slotid$); 	
	</insert>  
     <update id="modTargetChannel" parameterClass="java.util.Map">
		update adsrv.target_channel
		   set excflag = $excflag$,
		   	   slotid = $slotid$
           where tid = $tid$
             ;
	</update>       
	<insert id="addTargetChannelID" parameterClass="java.util.Map">
         INSERT INTO target_channel_id (
			tid
			, idx
			, channelid
			, channelname
			, stat
		) 
		<dynamic>
			<iterate prepend="VALUES" conjunction=", " property="List">
				( 
					#List[].tid# 
					, 0
					, #List[].channelid#
					, #List[].channelname#	
					, 1		
				)
			</iterate>
		</dynamic>
      </insert>
   
 	 <update id="modTargetChannelID" parameterClass="java.util.Map">
		update adsrv.target_channel_id
		   set stat = 0
           where tid = $tid$
          ;
	</update> 
      <delete id="delTargetChannelID" parameterClass="java.util.HashMap">
		delete 
		  from target_channel_id
		 where tid = $tid$
		   and stat = 0;
	  </delete>
      <insert id="addTemplate" parameterClass="java.util.HashMap">
	      insert into adsrv.template
	            (tmpid,
	             tmpname,
	             tmpcode,
	             memo, 
	             stat,
	             updatedate,
	             updateuser
	             )
			values (0,
		        #tmpname#,
		        #tmpcode#,
		        #memo#, 
		        1,
		        #updatedate#,
		        #userid#
		 	);
	 </insert>
	 <update id="modTemplate" parameterClass="java.util.HashMap">
		 update adsrv.template
		 	set <isNotEmpty property="tmpname">tmpname = '$tmpname$', </isNotEmpty>
		 	    <isNotEmpty property="imgflag">imgflag = $imgflag$, </isNotEmpty>
	            <isNotEmpty property="tmpcode">tmpcode = '$tmpcode$', </isNotEmpty>
	            <isNotEmpty property="memo">memo = '$memo$', </isNotEmpty>
	            <isNotEmpty property="stat">stat      = $stat$, </isNotEmpty> 
	            updatedate = $updatedate$,
	            updateuser = $userid$
	      where tmpid = $tmpid$
	 </update>
	 <select id="getTemplateList" resultClass="java.util.HashMap" parameterClass="java.util.Map">
		select a.tmpid, a.tmpname, imgflag, memo,
		       a.updateuser, u.username as updateusername, a.updatedate 
		 from template a		     
		      left join users u on a.updateuser = u.userid
		 where a.stat = 1     
		  	<isNotEmpty property="sch_text" prepend="and"> $sch_column$ like '%$sch_text$%' </isNotEmpty>
		 order by <isNotEmpty property="order_str"> $order_str$ ,</isNotEmpty>
		          a.updatedate desc
         <isNotEmpty property="max">
          limit $skip$,$max$
          </isNotEmpty>;
	</select>
	<select id="getTemplateCnt" resultClass="Integer" parameterClass="java.util.Map">
		select count(*)
		 from template a		     
		      left join users u on a.updateuser = u.userid
		 where a.stat = 1     
		  	<isNotEmpty property="sch_text" prepend="and"> $sch_column$ like '%$sch_text$%' </isNotEmpty>
	</select>
	 <select id="getTemplate" resultClass="java.util.HashMap" parameterClass="java.util.Map">
		select a.tmpid, a.tmpname, tmpcode, imgflag, memo,
		       a.updateuser, u.username as updateusername, a.updatedate 
		 from template a		     
		      left join users u on a.updateuser = u.userid
		 where a.tmpid = $tmpid$     
	</select>
	
</sqlMap>
	 